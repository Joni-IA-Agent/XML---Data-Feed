name: Daily Product Feed Refresh

# ── Triggers ────────────────────────────────────────────────────────────────
on:
  schedule:
    # Every day at 10:00 UTC = 06:00 Bolivia (BOT = UTC-4)
    - cron: '0 10 * * *'
  workflow_dispatch:
    # Allow manual trigger from the GitHub Actions tab

# ── Permissions ──────────────────────────────────────────────────────────────
permissions:
  contents: write   # needed to commit the updated XML back to the repo
  pages: write      # needed for GitHub Pages deployment
  id-token: write

# ── Job ──────────────────────────────────────────────────────────────────────
jobs:
  refresh-feed:
    name: Scrape → Generate → Publish
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout the repo
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # full history so git push works

      # 2. Set up Python
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip

      # 3. Install dependencies
      - name: Install Python dependencies
        run: pip install requests beautifulsoup4 lxml Pillow

      # 4. Create .tmp directory (gitignored, exists only in runner)
      - name: Prepare temp directory
        run: mkdir -p .tmp docs docs/images

      # 5. Scrape estropical.com → .tmp/products_raw.json
      - name: Scrape product catalog
        run: python tools/scrape_catalog.py

      # 6. Generate branded product images → docs/images/{id}.jpg
      - name: Generate branded images
        run: python tools/generate_branded_images.py

      # 7. Generate XML feed → docs/estropical_catalog.xml
      - name: Generate XML feed
        run: python tools/generate_xml_feed.py

      # 8. Validate XML is well-formed before committing
      - name: Validate XML
        run: |
          sudo apt-get install -y -q libxml2-utils
          xmllint --noout docs/estropical_catalog.xml
          echo "✅ XML is well-formed"

      # 9. Commit and push the updated feed and images
      - name: Commit updated feed and images
        run: |
          git config user.name  "feed-bot[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs/estropical_catalog.xml docs/images/
          # Only commit if there are actual changes
          if git diff --cached --quiet; then
            echo "No changes to the feed — skipping commit."
          else
            git commit -m "chore: refresh product feed $(date -u +'%Y-%m-%d %H:%M UTC')"
            git push
            echo "✅ Feed and images committed and pushed"
          fi
